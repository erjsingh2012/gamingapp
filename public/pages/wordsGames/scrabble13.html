<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <style>
    :root {
      --tile-size: 7.5vw;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: #1e4d9b;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      touch-action: none;
    }

    .scale-wrapper {
      width: 100%;
      max-width: 561px;
      height: 100vh;
      position: relative;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
    }

    .game-frame {
      height: 100%;
      width: 100%;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .panel {
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: monospace;
      font-size: 24px;
      padding: 10px;
      box-sizing: border-box;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
    }

    .top-panel-1 {
      background: linear-gradient(to right, #111111, #2c2c2c);
      font-weight: bold;
    }

    .top-panel-2 {
      background: linear-gradient(to right, #00c6ff, #007aff);
    }

    .bottom-panel-1 {
      background: linear-gradient(to right, #3a8dde, #2569be);
      font-style: italic;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
    }

    .bottom-panel-2 {
      background: linear-gradient(to right, #ffe082, #f4a742);
      color: #333333;
      font-weight: bold;
    }

    .bottom-panel-3 {
      background: linear-gradient(to right, #4facfe, #007aff);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .bottom-panel-4 {
      background: linear-gradient(to right, #4facfe, #007aff);
      color: #000;
      display: none;
      transition: transform 0.3s ease, margin-bottom 0.3s ease;
    }

    .game-area {
      flex: 1;
      background: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 0;
      width: 100%;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(11, 1fr);
      gap: 1px;
      width: 100%;
      max-width: 500px;
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      margin: 0 auto;
      /* Center board horizontally */
    }

    .tile {
      width: 100%;
      aspect-ratio: 1 / 1;
      font-size: 0.7rem;
      font-weight: bold;
      color: #ffffff;
      background: linear-gradient(to bottom, #e8f4d0, #b5f9f467);
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      text-transform: uppercase;
      border-radius: 10px;
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2),
        0 2px 4px rgba(0, 0, 0, 0.2);
      border: 1px solid #ccc;
      transition: transform 0.1s ease;
    }


    .TW {
      background: #c62828;
      color: #fff;
    }

    .DW {
      background: #f9a825;
      color: #fff;
    }

    .TL {
      background: #1565c0;
      color: #fff;
    }

    .DL {
      background: #6a1b9a;
      color: #fff;
    }

    .TW,
    .DW,
    .TL,
    .DL {
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    #rack {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px;
      gap: 6px;
    }

    #rack span {
      flex: 0 1 calc(12.5% - 12px);
      aspect-ratio: 1 / 1;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: clamp(16px, 5vw, 28px);
      padding: 0;
      margin: 0;
      background: #f4d03f;
      border: 3px solid #9e7e38;
      border-radius: 12px;
      font-weight: bold;
      cursor: grab;
      box-sizing: border-box;
    }

    .rack-placeholder {
      background: #ccc;
      color: #888;
      font-style: italic;
      cursor: default;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 16px;
      background: #039be5;
      color: white;
      padding: 10px 16px;
      text-decoration: none;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .placed-tile {
      font-weight: bold;
      background: linear-gradient(135deg, #4dcb57, #61c917) !important;
      color: #000 !important;
      z-index: 1;
    }
  </style>
</head>

<body>
  <div class="scale-wrapper" id="scale-wrapper">
    <div class="debug-panel" id="debug-panel"></div>
    <div class="game-frame">
      <div class="panel top-panel-1">WORDS with Friends 2</div>
      <div class="panel top-panel-2">Player Info Panel</div>
      <a class="back-link" href="../../index.html">⬅ Back to Lobby</a>
      <div class="game-area">
        <div class="board" id="board"></div>
      </div>
      <div class="panel bottom-panel-1">
        <span>Practice played FRIT for 14 points</span>
      </div>
      <div class="panel bottom-panel-2" id="rack"></div>
      <div class="panel bottom-panel-3">More | Pass | PLAY | Swap | Shuffle</div>
      <div class="panel bottom-panel-4" id="bottom-panel-4"></div>
    </div>
  </div>

  <script>
    const boardData = [
      ['TW', '', '', 'DL', '', '', 'DL', '', '', '', 'TW'],
      ['', 'DW', '', '', '', 'TL', '', '', '', 'DW', ''],
      ['', '', 'DW', '', '', '', '', '', 'DW', '', ''],
      ['DL', '', '', 'DW', '', '', '', 'DW', '', '', 'DL'],
      ['', '', '', '', 'DW', '', 'DW', '', '', '', ''],
      ['', 'TL', '', '', '', '★', '', '', '', 'TL', ''],
      ['', '', '', '', 'DW', '', 'DW', '', '', '', ''],
      ['DL', '', '', 'DW', '', '', '', 'DW', '', '', 'DL'],
      ['', '', 'DW', '', '', '', '', '', 'DW', '', ''],
      ['', 'DW', '', '', '', 'TL', '', '', '', 'DW', ''],
      ['TW', '', '', 'DL', '', '', 'DL', '', '', '', 'TW']
    ];

    const tileBag = [
      ...Array(9).fill('A'), ...Array(2).fill('B'), ...Array(2).fill('C'),
      ...Array(4).fill('D'), ...Array(12).fill('E'), ...Array(2).fill('F'),
      ...Array(3).fill('G'), ...Array(2).fill('H'), ...Array(9).fill('I'),
      ...Array(1).fill('J'), ...Array(1).fill('K'), ...Array(4).fill('L'),
      ...Array(2).fill('M'), ...Array(6).fill('N'), ...Array(8).fill('O'),
      ...Array(2).fill('P'), ...Array(1).fill('Q'), ...Array(6).fill('R'),
      ...Array(4).fill('S'), ...Array(6).fill('T'), ...Array(4).fill('U'),
      ...Array(2).fill('V'), ...Array(2).fill('W'), ...Array(1).fill('X'),
      ...Array(2).fill('Y'), ...Array(1).fill('Z'), ...Array(2).fill('_')
    ];

    const shuffle = arr => {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    };

    const drawTiles = count => {
      shuffle(tileBag);
      return tileBag.splice(0, count);
    };

    const populateRack = tiles => {
      const rack = document.getElementById('rack');
      rack.innerHTML = '';
      tiles.forEach(letter => {
        const tile = document.createElement('span');
        tile.textContent = letter;
        rack.appendChild(tile);
      });
    };

    const populateBoard = () => {
      const board = document.getElementById("board");
      boardData.forEach(row => {
        row.forEach(cell => {
          const tile = document.createElement("div");
          tile.className = "tile " + (cell || "");
          tile.textContent = cell || '';
          board.appendChild(tile);
        });
      });
    };

    // Initialize game
    populateBoard();
    populateRack(drawTiles(7));

    let draggedTile = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let originX = 0;
    let originY = 0;

    const initDraggableRackTiles = () => {
      const rack = document.getElementById('rack');

      rack.addEventListener('pointerdown', (e) => {
        const target = e.target;
        if (target.tagName !== 'SPAN') return;

        // Store origin for delta calculation
        originX = e.clientX;
        originY = e.clientY;

        // Create floating clone
        draggedTile = target.cloneNode(true);
        draggedTile.style.position = 'fixed';
        draggedTile.style.zIndex = '1000';
        draggedTile.style.pointerEvents = 'none';
        draggedTile.style.opacity = '0.9';
        draggedTile.style.transform = 'scale(1.8)';
        document.body.appendChild(draggedTile);


        // Instead of using tile size, use a fixed slight offset
        dragOffsetX = 25;  // adjust horizontally
        dragOffsetY = 25;  // adjust vertically

        moveDraggedTile(e);
      });

      document.addEventListener('pointermove', (e) => {
        if (!draggedTile) return;
        moveDraggedTile(e);

        // Calculate movement delta
        const deltaX = e.clientX - originX;
        const deltaY = e.clientY - originY;
        // For debugging:
        // console.log(`Moved X: ${deltaX}px, Y: ${deltaY}px`);
      });

      document.addEventListener('pointerup', () => {
        if (draggedTile) {
          draggedTile.remove();
          draggedTile = null;
        }
      });

      const moveDraggedTile = (e) => {
        if (!draggedTile) return;
        draggedTile.style.left = `${e.clientX - dragOffsetX}px`;
        draggedTile.style.top = `${e.clientY - dragOffsetY}px`;
      };
    };

    const dropTileOnBoard = () => {
      if (!draggedTile) return;

      const rect = draggedTile.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const target = document.elementFromPoint(centerX, centerY);

      if (target && target.classList.contains('tile')) {
        const cellText = target.textContent.trim();
        const isBonusCell = ['TW', 'DW', 'TL', 'DL', '★'].includes(cellText);

        if (cellText === '' || isBonusCell) {
          // Step 1a: Place the tile on the board
          target.textContent = draggedTile.textContent;

          target.classList.add('placed-tile');
          target.dataset.letter = draggedTile.textContent;

          // Step 1b: Replace the tile in the rack with a placeholder
          const rackSpans = [...document.querySelectorAll('#rack span')];
          const match = rackSpans.find(
            span => span.textContent === draggedTile.textContent && !span.dataset.empty
          );
          if (match) {
            match.textContent = '\u00A0';
            match.dataset.empty = 'true';
            match.classList.add('rack-placeholder');
          }
        }
      }
    };


    document.addEventListener('pointerup', (e) => {
      if (draggedTile) {
        dropTileOnBoard(e);
        draggedTile.remove();
        draggedTile = null;
      }
    });
    const rackTiles = drawTiles(7);
    populateRack(rackTiles);
    initDraggableRackTiles();
  </script>
</body>

</html>