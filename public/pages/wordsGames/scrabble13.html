<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Scrabble 13x13</title>
  <style>
    :root {
      --cell-size: min(7.0vw, 36px);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    h1 {
      margin: 20px 0 10px;
      font-size: 1.5rem;
      text-align: center;
      color: #333;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(13, var(--cell-size));
      grid-template-rows: repeat(13, var(--cell-size));
      gap: 1px;
      background: #bbb;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .cell {
      background: #eee;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: bold;
      color: #333;
      position: relative;
    }

    .TW { background: #d32f2f; color: white; }
    .DW { background: #f57c00; color: white; }
    .TL { background: #1976d2; color: white; }
    .DL { background: #7b1fa2; color: white; }

    .cell::after {
      content: attr(data-bonus);
      font-size: 0.55em;
      position: absolute;
      bottom: 2px;
      right: 4px;
      opacity: 0.6;
    }

    #rack {
      display: grid;
      grid-template-columns: repeat(7, var(--cell-size));
      gap: 8px;
      margin: 16px 0;
      justify-content: center;
      padding: 0 10px;
    }

    .rack-slot {
      width: var(--cell-size);
      height: var(--cell-size);
      border: 2px dashed #bbb;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f8f8;
    }

    .tile {
      width: var(--cell-size);
      height: var(--cell-size);
      background: #fff8dc;
      border: 1px solid #aaa;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      box-shadow: 1px 2px 4px rgba(0, 0, 0, 0.15);
      user-select: none;
      touch-action: none;
    }

    .tile:active {
      cursor: grabbing;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 0 10px;
    }

    #play-btn, .back-link {
      padding: 10px 16px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      cursor: pointer;
      text-decoration: none;
    }

    .back-link { background: #607d8b; }
    #play-btn:hover, .back-link:hover { background: #388e3c; }

    .ghost {
      position: fixed;
      z-index: 1000;
      opacity: 0.8;
      pointer-events: none;
      transform: scale(3);
    }
  </style>
</head>

<body>
  <h1>ðŸ§© Scrabble 13x13</h1>
  <div id="board"></div>
  <div id="rack"></div>
  <div id="controls">
    <a class="back-link" href="../../index.html">â¬… Back to Lobby</a>
    <button id="play-btn">Play Word</button>
  </div>

  <script>
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const letterValues = {
      A:1,B:3,C:3,D:2,E:1,F:4,G:2,H:4,I:1,J:8,K:5,L:1,M:3,N:1,O:1,P:3,
      Q:10,R:1,S:1,T:1,U:1,V:4,W:4,X:8,Y:4,Z:10
    };

    const bonusMap = [
      ['TW','','','','DL','','','','DL','','','','TW'],
      ['','DW','','','','','','','','','','DW',''],
      ['','','DW','','','','DL','','','','DW','',''],
      ['','DL','','DW','','','','','','DW','','DL',''],
      ['','','','','DW','','','','DW','','','',''],
      ['','','DL','','','','DL','','','','DL','',''],
      ['DL','','','','','','â˜…','','','','','','DL'],
      ['','','DL','','','','DL','','','','DL','',''],
      ['','','','','DW','','','','DW','','','',''],
      ['','DL','','DW','','','','','','DW','','DL',''],
      ['','','DW','','','','DL','','','','DW','',''],
      ['','DW','','','','','','','','','','DW',''],
      ['TW','','','','DL','','','','DL','','','','TW']
    ];

    const board = document.getElementById('board');
    const rack = document.getElementById('rack');
    let draggedTile = null;

    function createTile(letter) {
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.textContent = letter;
      tile.dataset.letter = letter;
      
      let isDragging = false;
      let tileGhost = null;

      function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        draggedTile = tile;
        
        tileGhost = tile.cloneNode(true);
        tileGhost.className = 'tile ghost';
        document.body.appendChild(tileGhost);
        
        const x = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX) || 0;
        const y = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY) || 0;
        updateGhost(x, y);
        
        // Add document listeners for this specific drag
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd, { passive: false });
      }

      function handleMouseMove(e) {
        if (!isDragging || !tileGhost) return;
        updateGhost(e.clientX, e.clientY);
      }
      
      function handleTouchMove(e) {
        if (!isDragging || !tileGhost) return;
        e.preventDefault();
        const x = e.touches && e.touches[0] && e.touches[0].clientX || 0;
        const y = e.touches && e.touches[0] && e.touches[0].clientY || 0;
        updateGhost(x, y);
      }

      function handleMouseUp(e) {
        if (!isDragging) return;
        endDrag(e.clientX, e.clientY);
      }
      
      function handleTouchEnd(e) {
        if (!isDragging) return;
        e.preventDefault();
        const touch = e.changedTouches && e.changedTouches[0];
        const x = touch ? touch.clientX : (tileGhost ? parseInt(tileGhost.style.left) + 18 : 0);
        const y = touch ? touch.clientY : (tileGhost ? parseInt(tileGhost.style.top) + 18 : 0);
        endDrag(x, y);
      }

      function endDrag(x, y) {
        if (!x || !y) {
          cleanup();
          return;
        }
        
        const target = document.elementFromPoint(x, y);
        const isValidTarget = target && 
                             (target.classList.contains('cell') || target.classList.contains('rack-slot')) && 
                             !target.hasChildNodes();

        if (isValidTarget) {
          const parent = tile.parentElement;
          if (parent && parent.classList.contains('cell')) {
            parent.dataset.tile = '';
          }
          
          target.appendChild(tile);
          if (target.classList.contains('cell')) {
            target.dataset.tile = tile.dataset.letter;
          }
        }

        cleanup();
      }
      
      function cleanup() {
        if (tileGhost) {
          tileGhost.remove();
          tileGhost = null;
        }
        isDragging = false;
        draggedTile = null;
        
        // Remove document listeners
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        document.removeEventListener('touchmove', handleTouchMove);
        document.removeEventListener('touchend', handleTouchEnd);
      }

      function updateGhost(x, y) {
        if (!tileGhost || !x || !y) return;
        const size = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-size')) || 36;
        const scaledSize = size * 3;
        tileGhost.style.left = `${x - scaledSize/2}px`;
        tileGhost.style.top = `${y - scaledSize/2}px`;
      }

      // Start drag events
      tile.addEventListener('mousedown', startDrag);
      tile.addEventListener('touchstart', startDrag, { passive: false });

      return tile;
    }

    // Build board
    for (let r = 0; r < 13; r++) {
      for (let c = 0; c < 13; c++) {
        const cell = document.createElement('div');
        const bonus = bonusMap[r][c];
        cell.className = 'cell' + (bonus ? ' ' + bonus : '');
        cell.dataset.row = r;
        cell.dataset.col = c;
        cell.dataset.tile = '';
        if (bonus) cell.dataset.bonus = bonus;
        board.appendChild(cell);
      }
    }

    // Generate rack
    function generateRack() {
      rack.innerHTML = '';
      for (let i = 0; i < 7; i++) {
        const slot = document.createElement('div');
        slot.className = 'rack-slot';
        const letter = letters[Math.floor(Math.random() * letters.length)];
        slot.appendChild(createTile(letter));
        rack.appendChild(slot);
      }
    }

    // Play button
    document.getElementById('play-btn').onclick = () => {
      const playedTiles = [...document.querySelectorAll('.cell')]
        .filter(cell => cell.dataset.tile)
        .map(cell => ({
          letter: cell.dataset.tile,
          row: +cell.dataset.row,
          col: +cell.dataset.col
        }));

      if (!playedTiles.length) {
        alert('Place tiles on the board first.');
        return;
      }

      const score = playedTiles.reduce((sum, t) => sum + (letterValues[t.letter] || 0), 0);
      alert(`Word Score: ${score} points`);
      generateRack();
    };

    generateRack();
  </script>
</body>
</html>